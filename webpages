<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>策略交易仪表盘 - 融合版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f8fafc;
        }
        
        /* 保留重构版的优雅侧边栏样式 */
        .sidebar-link, .sidebar-parent {
            display: flex; align-items: center; padding: 0.75rem 1rem;
            border-radius: 0.5rem; transition: all 0.2s ease-in-out;
            font-weight: 500; color: #4b5563; cursor: pointer;
        }
        .sidebar-link:hover, .sidebar-parent:hover { 
            background-color: #f3f4f6; color: #1f2937; 
        }
        .sidebar-link.active, .sidebar-parent.active { 
            background-color: #eef2ff; color: #4f46e5; font-weight: 600; 
        }
        .sidebar-submenu {
            padding-left: 1.5rem; max-height: 0;
            overflow: hidden; transition: max-height 0.3s ease-in-out;
        }
        .sidebar-submenu.open { max-height: 500px; }
        .sidebar-submenu .sidebar-link { padding: 0.6rem 1rem; font-size: 0.9rem; }
        .sidebar-link svg, .sidebar-parent svg { 
            margin-right: 0.75rem; width: 1.25rem; height: 1.25rem; 
        }
        
        /* 融合初稿版的丰富卡片样式 */
        .kpi-card {
            background-color: white; border: 1px solid #e5e7eb;
            border-radius: 0.75rem; padding: 1.25rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        .overview-strategy-card {
            background-color: white; border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            padding: 1.5rem; border: 1px solid #e5e7eb;
        }
        
        /* 按钮样式 */
        .btn-primary {
            background-color: #4f46e5; color: white; padding: 0.5rem 1rem;
            border-radius: 0.5rem; font-weight: 500; transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #4338ca; }
        
        /* 货币切换按钮 */
        .currency-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid #d1d5db;
            color: #6b7280;
        }
        .currency-btn.active {
            background-color: #eef2ff;
            color: #4f46e5;
            border-color: #a5b4fc;
            font-weight: 600;
        }
        
        /* 日历样式 */
        .calendar {
            display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 1px;
            background-color: #e2e8f0; border: 1px solid #e2e8f0; 
        }
        .calendar-header { 
            text-align: center; font-weight: 500; padding: 0.5rem; 
            background-color: #f1f5f9; 
        }
        .calendar-day {
            padding: 0.75rem 0.5rem; min-height: 80px; background-color: white;
            position: relative; font-size: 0.875rem; 
        }
        .calendar-day.profit-bg { background-color: #dcfce7; }
        .calendar-day.loss-bg { background-color: #fee2e2; }
        
        /* 表格样式 */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td {
            border: 1px solid #e2e8f0; padding: 0.75rem; text-align: left; font-size: 0.875rem; 
        }
        .data-table th { background-color: #f1f5f9; font-weight: 600; }
        .data-table tbody tr:nth-child(even) { background-color: #f8fafc; }
        
        /* 工具提示样式 */
        .pl-positive { color: #16a34a; }
        .pl-negative { color: #dc2626; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- 侧边栏 - 使用重构版的优雅设计 -->
        <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-chart-line mr-3 text-indigo-600"></i>
                    策略看板
                </h1>
            </div>
            <nav class="p-4 space-y-2">
                <a href="#overview" class="sidebar-link active" data-page="overview">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                    </svg>
                    概览仪表盘
                </a>
                <a href="#strategy-details" class="sidebar-link" data-page="strategy-details">
                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                   </svg>
                   策略业绩详情
                </a>
                <div>
                    <div id="menu-financials" class="sidebar-parent">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                        </svg>
                        财务管理
                    </div>
                    <div id="submenu-financials" class="sidebar-submenu">
                        <a href="#financials-dashboard" class="sidebar-link" data-page="financials-dashboard">仪表盘</a>
                        <a href="#financials-overview" class="sidebar-link" data-page="financials-overview">财务总览</a>
                        <a href="#billing" class="sidebar-link" data-page="billing">账单与计提</a>
                        <a href="#trading-log" class="sidebar-link" data-page="trading-log">交易日志</a>
                    </div>
                </div>
                <a href="#client-portal" class="sidebar-link" data-page="client-portal">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    客户账户中心
                </a>
                <a href="#api-monitor" class="sidebar-link" data-page="api-monitor">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    API连接监控
                </a>
                <a href="#position-management" class="sidebar-link" data-page="position-management">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    实时持仓管理
                </a>
                <a href="#profit-sharing" class="sidebar-link" data-page="profit-sharing">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                    分润计算管理
                </a>
                <a href="#bill-generator" class="sidebar-link" data-page="bill-generator">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    账单生成系统
                </a>
                <a href="#reporting" class="sidebar-link" data-page="reporting">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    报表中心
                </a>
                <a href="#settings" class="sidebar-link" data-page="settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    系统设置
                </a>
            </nav>
        </aside>

        <!-- 主内容区域 -->
        <main class="flex-1 overflow-y-auto">
            <header class="sticky top-0 bg-white/80 backdrop-blur-sm border-b border-gray-200 p-6 flex justify-between items-center">
                <h2 id="pageTitle" class="text-2xl font-semibold text-gray-900">概览仪表盘</h2>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" placeholder="搜索策略/客户..." class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <i class="fas fa-search text-gray-400"></i>
                        </span>
                    </div>
                    <button class="text-gray-500 hover:text-gray-700 relative">
                        <i class="fas fa-bell text-xl"></i>
                        <span class="absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                    </button>
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-indigo-200 rounded-full flex items-center justify-center font-bold text-indigo-700">
                            <i class="fas fa-user"></i>
                        </div>
                        <span class="ml-2 text-sm font-medium text-gray-700">高级管理员</span>
                        <i class="fas fa-chevron-down text-xs text-gray-500 ml-1"></i>
                    </div>
                </div>
            </header>
            
            <div class="p-8">
                <!-- 概览页面 -->
                <section id="page-overview" class="page">
                    <div class="mb-6">
                        <h1 class="text-3xl font-semibold text-slate-800">策略总览</h1>
                        <p class="text-slate-600 mt-2">集中展示所有核心投资策略的实时表现概览</p>
                    </div>
                    
                    <!-- 平台总体KPI -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="kpi-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">总管理资产</p>
                                    <p class="text-2xl font-bold text-gray-800 mt-1" id="overview-total-aum">-</p>
                                </div>
                                <div class="p-3 bg-blue-100 rounded-full">
                                    <i class="fas fa-chart-line text-blue-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">本月总收益</p>
                                    <p class="text-2xl font-bold text-green-600 mt-1" id="overview-monthly-profit">-</p>
                                </div>
                                <div class="p-3 bg-green-100 rounded-full">
                                    <i class="fas fa-dollar-sign text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">活跃客户数</p>
                                    <p class="text-2xl font-bold text-indigo-600 mt-1" id="overview-active-clients">-</p>
                                </div>
                                <div class="p-3 bg-indigo-100 rounded-full">
                                    <i class="fas fa-users text-indigo-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">策略胜率</p>
                                    <p class="text-2xl font-bold text-purple-600 mt-1" id="overview-win-rate">-</p>
                                </div>
                                <div class="p-3 bg-purple-100 rounded-full">
                                    <i class="fas fa-trophy text-purple-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 策略卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8" id="overview-strategies-container">
                        <!-- 策略卡片将在这里动态生成 -->
                    </div>
                    
                    <!-- 底部附加信息 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 最近交易活动 -->
                        <div class="bg-white p-6 rounded-lg border">
                            <h3 class="font-semibold text-gray-800 mb-4">最近交易活动</h3>
                            <div id="recent-trades" class="space-y-3">
                                <!-- 最近交易将在这里显示 -->
                            </div>
                        </div>
                        
                        <!-- 系统状态 -->
                        <div class="bg-white p-6 rounded-lg border">
                            <h3 class="font-semibold text-gray-800 mb-4">系统状态</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">API连接状态</span>
                                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800" id="api-status">正常</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">策略运行状态</span>
                                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800" id="strategy-status">运行中</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">数据同步状态</span>
                                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800" id="sync-status">已同步</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">最后更新时间</span>
                                    <span class="text-sm text-gray-500" id="last-update">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 其他页面容器 -->
                <section id="page-strategy-details" class="page hidden">
                    <div class="bg-white p-6 rounded-lg border mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <label for="strategy-selector" class="text-sm font-medium text-gray-700">选择策略:</label>
                                <select id="strategy-selector" class="ml-2 rounded-md border-gray-300 shadow-sm"></select>
                            </div>
                        </div>
                        <h3 id="details-strategy-title" class="text-xl font-semibold mb-4"></h3>
                        <div id="strategy-chart" style="width: 100%; height: 400px;"></div>
                    </div>
                    
                    <!-- 下方两个卡片：策略介绍 + 收益日历 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 策略介绍卡片 -->
                        <div class="bg-white p-6 rounded-lg border">
                            <h3 class="font-semibold text-gray-800 mb-4">策略介绍</h3>
                            <div id="strategy-description" class="space-y-4">
                                <!-- 策略介绍内容将在这里动态生成 -->
                            </div>
                            
                            <!-- 策略关键指标 -->
                            <div class="mt-6">
                                <h4 class="font-medium text-gray-700 mb-3">关键指标</h4>
                                <div id="strategy-kpis" class="grid grid-cols-2 gap-4">
                                    <!-- KPI指标将在这里动态生成 -->
                                </div>
                            </div>
                            
                            <!-- 风险提示 -->
                            <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                                <h4 class="font-medium text-yellow-800 mb-2">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>风险提示
                                </h4>
                                <p class="text-sm text-yellow-700" id="risk-warning">
                                    <!-- 风险提示内容将在这里动态生成 -->
                                </p>
                            </div>
                        </div>
                        
                        <!-- 收益日历卡片 -->
                        <div class="bg-white p-6 rounded-lg border">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-semibold text-gray-800">收益日历</h3>
                                <div id="calendar-currency-switcher" class="flex items-center rounded-md border">
                                    <button class="currency-btn rounded-l-md" data-currency="CNY">CNY</button>
                                    <button class="currency-btn rounded-r-md" data-currency="USD">USD</button>
                                </div>
                            </div>
                            <div id="earnings-calendar" class="calendar"></div>
                            
                            <!-- 日历统计 -->
                            <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                                <div class="p-2 bg-green-50 rounded">
                                    <p class="text-xs text-green-600">盈利天数</p>
                                    <p class="font-semibold text-green-700" id="profit-days">-</p>
                                </div>
                                <div class="p-2 bg-red-50 rounded">
                                    <p class="text-xs text-red-600">亏损天数</p>
                                    <p class="font-semibold text-red-700" id="loss-days">-</p>
                                </div>
                                <div class="p-2 bg-gray-50 rounded">
                                    <p class="text-xs text-gray-600">胜率</p>
                                    <p class="font-semibold text-gray-700" id="win-rate">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 财务管理页面 -->
                <section id="page-financials-dashboard" class="page hidden">
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">平台总管理规模 (AUM)</p>
                            <p id="fd-aum" class="text-2xl font-bold text-gray-800 mt-1">-</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">平台总应占毛利润</p>
                            <p id="fd-gross-profit" class="text-2xl font-bold text-indigo-600 mt-1">-</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">平台总成本</p>
                            <p id="fd-cost" class="text-2xl font-bold text-orange-600 mt-1">-</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">平台总净利润</p>
                            <p id="fd-net-profit" class="text-2xl font-bold text-green-600 mt-1">-</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200">
                         <div class="p-6 border-b">
                            <h3 class="font-semibold text-gray-800">账户财务状况细分</h3>
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">选择月份:</label>
                                    <input type="month" id="fd-month-selector" value="2024-05" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">选择账户:</label>
                                    <select id="fd-account-selector" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                                </div>
                            </div>
                         </div>
                         <div id="fd-breakdown-content" class="p-6 grid grid-cols-2 lg:grid-cols-4 gap-6"></div>
                    </div>
                </section>

                <!-- 其他页面占位符 -->
                <section id="page-financials-overview" class="page hidden">
                    <div class="mb-6">
                        <h1 class="text-3xl font-semibold text-slate-800">财务总览</h1>
                        <p class="text-slate-600 mt-2">全面分析公司财务状况和盈利趋势</p>
                    </div>
                    
                    <!-- 财务KPI总览 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">本月总分润</p>
                            <p class="text-2xl font-bold text-green-600 mt-1" id="fo-total-profit">-</p>
                            <p class="text-xs text-gray-500 mt-1">较上月 +12.5%</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">运营成本</p>
                            <p class="text-2xl font-bold text-orange-600 mt-1" id="fo-total-cost">-</p>
                            <p class="text-xs text-gray-500 mt-1">较上月 +3.2%</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">净利润</p>
                            <p class="text-2xl font-bold text-indigo-600 mt-1" id="fo-net-profit">-</p>
                            <p class="text-xs text-gray-500 mt-1">较上月 +18.7%</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">利润率</p>
                            <p class="text-2xl font-bold text-purple-600 mt-1" id="fo-profit-margin">-</p>
                            <p class="text-xs text-gray-500 mt-1">较上月 +2.1%</p>
                        </div>
                    </div>
                    
                    <!-- 主要图表区域 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg border">
                            <h3 class="font-semibold text-gray-800 mb-4">公司应收分润策略来源分布</h3>
                            <div id="strategy-contribution-chart" style="width: 100%; height: 300px;"></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg border">
                            <h3 class="font-semibold text-gray-800 mb-4">公司利润与成本趋势</h3>
                            <div id="monthly-profit-chart" style="width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                    
                    <!-- 详细分析区域 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <!-- 客户贡献排行 -->
                        <div class="bg-white p-6 rounded-lg border">
                            <h3 class="font-semibold text-gray-800 mb-4">客户贡献排行</h3>
                            <div id="client-ranking" class="space-y-3">
                                <!-- 客户排行将在这里显示 -->
                            </div>
                        </div>
                        
                        <!-- 策略表现对比 -->
                        <div class="bg-white p-6 rounded-lg border">
                            <h3 class="font-semibold text-gray-800 mb-4">策略表现对比</h3>
                            <div id="strategy-performance" class="space-y-3">
                                <!-- 策略表现将在这里显示 -->
                            </div>
                        </div>
                        
                        <!-- 风险指标 -->
                        <div class="bg-white p-6 rounded-lg border">
                            <h3 class="font-semibold text-gray-800 mb-4">风险指标</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">最大回撤</span>
                                    <span class="text-sm font-semibold text-red-600">-5.2%</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">夏普比率</span>
                                    <span class="text-sm font-semibold text-green-600">2.1</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">波动率</span>
                                    <span class="text-sm font-semibold text-yellow-600">12.5%</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">VaR (95%)</span>
                                    <span class="text-sm font-semibold text-orange-600">$15,200</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 月度收益分解 -->
                    <div class="bg-white p-6 rounded-lg border">
                        <h3 class="font-semibold text-gray-800 mb-4">月度收益分解</h3>
                        <div id="monthly-breakdown-chart" style="width: 100%; height: 350px;"></div>
                    </div>
                </section>

                <section id="page-billing" class="page hidden">
                    <div class="bg-white p-6 rounded-lg border">
                        <h3 class="font-semibold text-gray-800 mb-4">账单与计提</h3>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>账单日期</th>
                                        <th>类型</th>
                                        <th>客户/账户</th>
                                        <th class="text-right">金额 ($)</th>
                                        <th class="text-center">状态</th>
                                    </tr>
                                </thead>
                                <tbody id="billing-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="page-trading-log" class="page hidden">
                     <div class="bg-white p-6 rounded-lg border">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold text-gray-800">交易日志</h3>
                            <div class="flex space-x-3">
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm font-medium text-gray-700">日期范围:</label>
                                    <input type="date" id="log-start-date" class="rounded-md border-gray-300 shadow-sm text-sm" value="2024-05-01">
                                    <span class="text-gray-500">至</span>
                                    <input type="date" id="log-end-date" class="rounded-md border-gray-300 shadow-sm text-sm" value="2024-05-31">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm font-medium text-gray-700">策略:</label>
                                    <select id="log-strategy-filter" class="rounded-md border-gray-300 shadow-sm text-sm">
                                        <option value="all">全部策略</option>
                                        <option value="趋势跟踪策略">趋势跟踪策略</option>
                                        <option value="均值回归策略">均值回归策略</option>
                                        <option value="套利策略">套利策略</option>
                                        <option value="高频交易策略">高频交易策略</option>
                                    </select>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm font-medium text-gray-700">交易类型:</label>
                                    <select id="log-type-filter" class="rounded-md border-gray-300 shadow-sm text-sm">
                                        <option value="all">全部类型</option>
                                        <option value="买入">买入</option>
                                        <option value="卖出">卖出</option>
                                    </select>
                                </div>
                                <button class="btn-primary text-sm" onclick="filterTradingLog()">
                                    <i class="fas fa-filter mr-1"></i>筛选
                                </button>
                                <button class="text-gray-600 hover:text-gray-800 text-sm px-3 py-2 border border-gray-300 rounded-md" onclick="resetTradingLogFilter()">
                                    <i class="fas fa-undo mr-1"></i>重置
                                </button>
                            </div>
                        </div>
                        
                        <!-- 筛选结果统计 -->
                        <div class="mb-4 p-3 bg-gray-50 rounded-md">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">筛选结果: <span id="filtered-count" class="font-semibold text-gray-800">0</span> 条记录</span>
                                <div class="flex space-x-4">
                                    <span class="text-gray-600">买入: <span id="buy-count" class="font-semibold text-green-600">0</span> 笔</span>
                                    <span class="text-gray-600">卖出: <span id="sell-count" class="font-semibold text-red-600">0</span> 笔</span>
                                    <span class="text-gray-600">总金额: <span id="total-amount" class="font-semibold text-blue-600">$0</span></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>日期 时间</th>
                                        <th>策略名称</th>
                                        <th>类型</th>
                                        <th class="text-right">总金额 ($)</th>
                                    </tr>
                                </thead>
                                <tbody id="trading-log-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="page-client-portal" class="page hidden">
                    <div class="bg-white p-8 rounded-lg border">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">客户账户中心</h3>
                        <p class="text-gray-600">客户账户管理功能正在开发中...</p>
                    </div>
                </section>

                <section id="page-api-monitor" class="page hidden">
                    <div class="mb-6">
                        <h1 class="text-3xl font-semibold text-slate-800">API连接监控</h1>
                        <p class="text-slate-600 mt-2">实时监控客户账户API连接状态和交易权限</p>
                    </div>
                    
                    <!-- API状态总览 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">总连接数</p>
                            <p class="text-2xl font-bold text-gray-800 mt-1" id="total-connections">-</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">正常连接</p>
                            <p class="text-2xl font-bold text-green-600 mt-1" id="active-connections">-</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">异常连接</p>
                            <p class="text-2xl font-bold text-red-600 mt-1" id="failed-connections">-</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">今日交易次数</p>
                            <p class="text-2xl font-bold text-blue-600 mt-1" id="today-trades">-</p>
                        </div>
                    </div>

                    <!-- API连接详情表格 -->
                    <div class="bg-white p-6 rounded-lg border">
                        <h3 class="font-semibold text-gray-800 mb-4">API连接详情</h3>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>客户名称</th>
                                        <th>账户ID</th>
                                        <th>交易所</th>
                                        <th>连接状态</th>
                                        <th>最后心跳</th>
                                        <th>今日交易</th>
                                        <th>权限状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="api-connections-table"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="page-position-management" class="page hidden">
                    <div class="mb-6">
                        <h1 class="text-3xl font-semibold text-slate-800">实时持仓管理</h1>
                        <p class="text-slate-600 mt-2">监控所有客户账户的实时持仓和浮动盈亏</p>
                    </div>

                    <!-- 持仓总览 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">总持仓价值</p>
                            <p class="text-2xl font-bold text-gray-800 mt-1" id="total-position-value">-</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">总浮动盈亏</p>
                            <p class="text-2xl font-bold mt-1" id="total-unrealized-pnl">-</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">持仓品种数</p>
                            <p class="text-2xl font-bold text-blue-600 mt-1" id="total-symbols">-</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm font-medium text-gray-500">风险敞口</p>
                            <p class="text-2xl font-bold text-orange-600 mt-1" id="risk-exposure">-</p>
                        </div>
                    </div>

                    <!-- 持仓详情 -->
                    <div class="bg-white p-6 rounded-lg border">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold text-gray-800">持仓详情</h3>
                            <div class="flex space-x-2">
                                <select id="position-filter" class="rounded-md border-gray-300 shadow-sm text-sm">
                                    <option value="all">所有账户</option>
                                    <option value="profitable">盈利持仓</option>
                                    <option value="losing">亏损持仓</option>
                                </select>
                                <button class="btn-primary text-sm" onclick="refreshPositions()">
                                    <i class="fas fa-sync-alt mr-1"></i>刷新
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>客户账户</th>
                                        <th>策略</th>
                                        <th>交易对</th>
                                        <th>方向</th>
                                        <th>数量</th>
                                        <th>开仓价格</th>
                                        <th>当前价格</th>
                                        <th>浮动盈亏</th>
                                        <th>盈亏比例</th>
                                        <th>持仓时间</th>
                                    </tr>
                                </thead>
                                <tbody id="positions-table"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="page-profit-sharing" class="page hidden">
                    <div class="mb-6">
                        <h1 class="text-3xl font-semibold text-slate-800">分润计算管理</h1>
                        <p class="text-slate-600 mt-2">管理客户分润比例和自动计算应收金额</p>
                    </div>

                    <!-- 自动分润计算 -->
                    <div class="bg-white p-6 rounded-lg border mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold text-gray-800">本月分润自动计算</h3>
                            <div class="flex space-x-2">
                                <select id="profit-month-selector" class="rounded-md border-gray-300 shadow-sm text-sm">
                                    <option value="2024-05">2024年5月</option>
                                    <option value="2024-04">2024年4月</option>
                                    <option value="2024-03">2024年3月</option>
                                </select>
                                <button class="btn-primary text-sm" onclick="autoCalculateProfit()">
                                    <i class="fas fa-calculator mr-1"></i>自动计算
                                </button>
                            </div>
                        </div>
                        <div id="auto-profit-results" class="grid grid-cols-1 gap-4">
                            <!-- 自动计算结果将在这里显示 -->
                        </div>
                    </div>

                    <!-- 客户多策略分润详情 -->
                    <div class="bg-white p-6 rounded-lg border mb-6">
                        <h3 class="font-semibold text-gray-800 mb-4">客户多策略分润详情</h3>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>客户名称</th>
                                        <th>账户ID</th>
                                        <th>策略名称</th>
                                        <th>期初资金</th>
                                        <th>期末资金</th>
                                        <th>已实现盈亏</th>
                                        <th>浮动盈亏</th>
                                        <th>总盈亏</th>
                                        <th>分润比例</th>
                                        <th>应收分润</th>
                                    </tr>
                                </thead>
                                <tbody id="multi-strategy-profit-table"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 分润设置 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg border">
                            <h3 class="font-semibold text-gray-800 mb-4">分润比例设置</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">选择客户:</label>
                                    <select id="client-selector" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" onchange="loadClientStrategies()">
                                        <option value="">请选择客户</option>
                                    </select>
                                </div>
                                <div id="strategy-rates-container" style="display: none;">
                                    <label class="text-sm font-medium text-gray-700">策略分润设置:</label>
                                    <div id="strategy-rates-list" class="mt-2 space-y-2">
                                        <!-- 策略分润设置将在这里显示 -->
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">生效日期:</label>
                                    <input type="date" id="effective-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <button class="btn-primary w-full" onclick="updateProfitShare()">
                                    <i class="fas fa-save mr-2"></i>保存设置
                                </button>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg border">
                            <h3 class="font-semibold text-gray-800 mb-4">分润计算器</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">客户总盈利:</label>
                                    <input type="number" id="client-profit" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="输入客户盈利金额" oninput="calculateProfitShare()">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">分润比例:</label>
                                    <input type="number" id="calc-share-rate" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="输入分润比例%" oninput="calculateProfitShare()">
                                </div>
                                <div class="bg-gray-50 p-4 rounded-md">
                                    <p class="text-sm text-gray-600">应收金额:</p>
                                    <p class="text-2xl font-bold text-green-600" id="calculated-amount">$0.00</p>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-md">
                                    <p class="text-sm text-blue-600">客户净收益:</p>
                                    <p class="text-xl font-bold text-blue-600" id="client-net-amount">$0.00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 分润历史记录 -->
                    <div class="bg-white p-6 rounded-lg border">
                        <h3 class="font-semibold text-gray-800 mb-4">分润历史记录</h3>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>日期</th>
                                        <th>客户</th>
                                        <th>账户</th>
                                        <th>策略</th>
                                        <th>客户盈利</th>
                                        <th>分润比例</th>
                                        <th>应收金额</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody id="profit-share-history"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="page-bill-generator" class="page hidden">
                    <div class="mb-6">
                        <h1 class="text-3xl font-semibold text-slate-800">账单生成系统</h1>
                        <p class="text-slate-600 mt-2">自动生成和管理客户月度账单</p>
                    </div>

                    <!-- 账单生成工具 -->
                    <div class="bg-white p-6 rounded-lg border mb-6">
                        <h3 class="font-semibold text-gray-800 mb-4">生成新账单</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700">选择客户:</label>
                                <select id="bill-client-selector" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">请选择客户</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">账单月份:</label>
                                <input type="month" id="bill-month" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">账单类型:</label>
                                <select id="bill-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="performance">业绩报酬</option>
                                    <option value="management">管理费</option>
                                    <option value="both">业绩报酬+管理费</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button class="btn-primary w-full" onclick="generateBill()">
                                    <i class="fas fa-file-invoice mr-2"></i>生成账单
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 账单预览 -->
                    <div class="bg-white p-6 rounded-lg border mb-6" id="bill-preview" style="display: none;">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold text-gray-800">账单预览</h3>
                            <div class="space-x-2">
                                <button class="btn-primary" onclick="saveBill()">
                                    <i class="fas fa-save mr-1"></i>保存
                                </button>
                                <button class="btn-primary" onclick="sendBill()">
                                    <i class="fas fa-paper-plane mr-1"></i>发送
                                </button>
                                <button class="btn-primary" onclick="downloadBill()">
                                    <i class="fas fa-download mr-1"></i>下载PDF
                                </button>
                            </div>
                        </div>
                        <div id="bill-content" class="border p-6 bg-gray-50 rounded-md">
                            <!-- 账单内容将在这里生成 -->
                        </div>
                    </div>

                    <!-- 已生成账单列表 -->
                    <div class="bg-white p-6 rounded-lg border">
                        <h3 class="font-semibold text-gray-800 mb-4">账单管理</h3>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>账单编号</th>
                                        <th>客户</th>
                                        <th>账单月份</th>
                                        <th>类型</th>
                                        <th>金额</th>
                                        <th>生成日期</th>
                                        <th>发送状态</th>
                                        <th>付款状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="bills-management-table"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="page-reporting" class="page hidden">
                    <div class="bg-white p-8 rounded-lg border">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">报表中心</h3>
                        <p class="text-gray-600">报表生成功能正在开发中...</p>
                    </div>
                </section>

                <section id="page-settings" class="page hidden">
                    <div class="bg-white p-8 rounded-lg border">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">系统设置</h3>
                        <p class="text-gray-600">系统配置功能正在开发中...</p>
                    </div>
                </section>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. 模拟数据 ---
    const mockData = {
        strategies: {
            "cross-exchange": { 
                name: "跨所套利策略", 
                kpis: { 
                    totalReturn: 0.255, 
                    annualReturn: 0.182, 
                    maxDrawdown: -0.051, 
                    sharpeRatio: 2.1 
                }, 
                seriesData: Array.from({ length: 120 }, (_, i) => [
                    new Date(2023, 0, i + 1).getTime(), 
                    10000 * (1 + (Math.random() - 0.45) * 0.01 * i * 0.1)
                ]), 
                dailyPnl: Array.from({ length: 31 }, (_, i) => ({ 
                    day: i + 1, 
                    pnl: (Math.random() - 0.4) * 2000 
                })),
                description: "利用不同交易所间的价格差异进行套利交易，通过高频交易技术捕捉市场微观结构中的价格不一致性。",
                features: ["低风险", "高频交易", "市场中性", "技术驱动"],
                riskWarning: "套利策略虽然风险相对较低，但在极端市场条件下可能面临流动性风险和技术风险。"
            },
            "multi-factor": { 
                name: "多因子对冲策略", 
                kpis: { 
                    totalReturn: 0.189, 
                    annualReturn: 0.125, 
                    maxDrawdown: -0.078, 
                    alpha: 0.035,
                    beta: 0.65 
                }, 
                seriesData: Array.from({ length: 120 }, (_, i) => [
                    new Date(2023, 0, i + 1).getTime(), 
                    10000 * (1 + (Math.random() - 0.48) * 0.01 * i * 0.08)
                ]), 
                dailyPnl: Array.from({ length: 31 }, (_, i) => ({ 
                    day: i + 1, 
                    pnl: (Math.random() - 0.5) * 2500 
                })),
                description: "基于多个量化因子构建的对冲策略，通过因子暴露度控制和风险对冲实现稳定收益。",
                features: ["多因子模型", "风险对冲", "量化选股", "动态调仓"],
                riskWarning: "多因子策略依赖历史数据建模，在市场结构发生重大变化时可能面临模型失效风险。"
            },
            "momentum-trading": { 
                name: "动量交易策略", 
                kpis: { 
                    totalReturn: 0.321, 
                    annualReturn: 0.198, 
                    maxDrawdown: -0.092, 
                    sharpeRatio: 1.8 
                }, 
                seriesData: Array.from({ length: 120 }, (_, i) => [
                    new Date(2023, 0, i + 1).getTime(), 
                    10000 * (1 + (Math.random() - 0.4) * 0.005 * i * 0.15)
                ]), 
                dailyPnl: Array.from({ length: 31 }, (_, i) => ({ 
                    day: i + 1, 
                    pnl: (Math.random() - 0.3) * 1500 
                })),
                description: "捕捉市场趋势和动量效应，通过技术分析和量化信号识别价格趋势的延续性。",
                features: ["趋势跟踪", "技术分析", "动量因子", "止损保护"],
                riskWarning: "动量策略在市场反转时可能面临较大回撤，需要严格的风险控制和止损机制。"
            },
        },
        financials: {
            "202405": {
                companyCosts: 15000,
                accounts: [
                    { client: '客户 A', accountId: 'A-001', strategy: '跨所套利策略', initialAssets: 500000, finalAssets: 535000, realizedPnl: 28000, unrealizedPnl: 7000, shareRate: 0.3 },
                    { client: '客户 B', accountId: 'B-001', strategy: '多因子对冲策略', initialAssets: 1200000, finalAssets: 1296000, realizedPnl: 110000, unrealizedPnl: -14000, shareRate: 0.3 },
                    { client: '客户 C', accountId: 'C-001', strategy: '动量交易策略', initialAssets: 2000000, finalAssets: 2080000, realizedPnl: 55000, unrealizedPnl: 25000, shareRate: 0.4 },
                    { client: '客户 A', accountId: 'A-002', strategy: '多因子对冲策略', initialAssets: 100000, finalAssets: 101000, realizedPnl: -2000, unrealizedPnl: 3000, shareRate: 0.3 },
                ]
            },
            bills: [
                { date: '2024-06-01', type: '业绩报酬', account: '客户A资金账户', amount: 10500, status: '已收款' },
                { date: '2024-06-01', type: '业绩报酬', account: '客户B资金账户', amount: 28800, status: '已出账' },
                { date: '2024-05-28', type: '管理费', account: '客户C资金账户', amount: 5200, status: '已收款' },
                { date: '2024-05-25', type: '业绩报酬', account: '客户A资金账户-002', amount: 1200, status: '待收款' }
            ],
            tradeLog: [
                { datetime: '2024-05-25 10:15:30', strategy: '跨所套利策略', type: '买入', total: 34000 },
                { datetime: '2024-05-26 14:20:05', strategy: '多因子对冲策略', type: '买入', total: 35000 },
                { datetime: '2024-05-27 09:30:15', strategy: '动量交易策略', type: '卖出', total: 28500 },
                { datetime: '2024-05-28 16:45:22', strategy: '跨所套利策略', type: '买入', total: 42000 }
            ],
            btcPerformance: Array.from({ length: 120 }, (_, i) => [
                new Date(2023, 0, i + 1).getTime(), 
                16000 * (1 + Math.sin(i / 10) * 0.1 + (Math.random() - 0.5) * 0.05)
            ])
        },
        // 新增API连接数据
        apiConnections: [
            { client: '客户 A', accountId: 'A-001', exchange: 'Binance', status: 'connected', lastHeartbeat: '2024-06-13 18:25:30', todayTrades: 45, permissions: 'spot,futures', apiKey: 'BIN***123' },
            { client: '客户 B', accountId: 'B-001', exchange: 'OKX', status: 'connected', lastHeartbeat: '2024-06-13 18:25:28', todayTrades: 32, permissions: 'spot,futures,options', apiKey: 'OKX***456' },
            { client: '客户 C', accountId: 'C-001', exchange: 'Bybit', status: 'disconnected', lastHeartbeat: '2024-06-13 17:45:12', todayTrades: 0, permissions: 'spot', apiKey: 'BYB***789' },
            { client: '客户 A', accountId: 'A-002', exchange: 'Binance', status: 'connected', lastHeartbeat: '2024-06-13 18:25:25', todayTrades: 18, permissions: 'spot,futures', apiKey: 'BIN***124' }
        ],
        // 新增持仓数据
        positions: [
            { client: '客户 A', accountId: 'A-001', strategy: '跨所套利策略', symbol: 'BTC/USDT', side: 'long', quantity: 0.5, entryPrice: 65000, currentPrice: 67200, unrealizedPnl: 1100, pnlPercent: 3.38, holdTime: '2天3小时' },
            { client: '客户 B', accountId: 'B-001', strategy: '多因子对冲策略', symbol: 'ETH/USDT', side: 'short', quantity: 10, entryPrice: 3500, currentPrice: 3420, unrealizedPnl: 800, pnlPercent: 2.29, holdTime: '1天12小时' },
            { client: '客户 C', accountId: 'C-001', strategy: '动量交易策略', symbol: 'SOL/USDT', side: 'long', quantity: 100, entryPrice: 145, currentPrice: 142, unrealizedPnl: -300, pnlPercent: -2.07, holdTime: '6小时' },
            { client: '客户 A', accountId: 'A-002', strategy: '多因子对冲策略', symbol: 'ADA/USDT', side: 'long', quantity: 5000, entryPrice: 0.45, currentPrice: 0.47, unrealizedPnl: 100, pnlPercent: 4.44, holdTime: '3天' }
        ],
        // 新增分润历史数据
        profitShareHistory: [
            { date: '2024-05-31', client: '客户 A', accountId: 'A-001', clientProfit: 35000, shareRate: 30, ourShare: 10500, status: '已收款' },
            { date: '2024-05-31', client: '客户 B', accountId: 'B-001', clientProfit: 96000, shareRate: 30, ourShare: 28800, status: '已出账' },
            { date: '2024-05-31', client: '客户 C', accountId: 'C-001', clientProfit: 80000, shareRate: 40, ourShare: 32000, status: '已收款' },
            { date: '2024-04-30', client: '客户 A', accountId: 'A-001', clientProfit: 20000, shareRate: 30, ourShare: 6000, status: '已收款' }
        ],
        // 新增账单管理数据
        billsManagement: [
            { billNo: 'BILL-202405-001', client: '客户 A', month: '2024-05', type: '业绩报酬', amount: 10500, generateDate: '2024-06-01', sendStatus: '已发送', paymentStatus: '已付款' },
            { billNo: 'BILL-202405-002', client: '客户 B', month: '2024-05', type: '业绩报酬', amount: 28800, generateDate: '2024-06-01', sendStatus: '已发送', paymentStatus: '待付款' },
            { billNo: 'BILL-202405-003', client: '客户 C', month: '2024-05', type: '业绩报酬+管理费', amount: 34200, generateDate: '2024-06-01', sendStatus: '草稿', paymentStatus: '未发送' }
        ]
    };
    
    // --- 2. 工具函数 ---
    let activeStrategyId = 'cross-exchange';
    let activeCalendarCurrency = 'CNY';
    const exchangeRateUSDToCNY = 6.9;
    
    const formatNumber = (num, decimals = 0) => num.toLocaleString('en-US', { 
        minimumFractionDigits: decimals, 
        maximumFractionDigits: decimals 
    });
    
    const formatMoney = (num, currency) => {
        let amount = num;
        let symbol = '¥';
        if (currency === 'USD') {
            amount /= exchangeRateUSDToCNY;
            symbol = '$';
        }
        const sign = amount >= 0 ? '+' : '';
        const colorClass = amount >= 0 ? 'pl-positive' : 'pl-negative';
        return `<span class="font-mono text-xs ${colorClass}">${sign}${symbol}${Math.abs(amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>`;
    };
    
    const formatMoneyForKpi = (num) => `$${formatNumber(num, 2)}`;
    const formatPercentage = (num) => `${(num * 100).toFixed(1)}%`;
    
    // --- 3. 渲染函数 ---
    function renderOverview() {
        // 更新平台总体KPI
        const totalAum = mockData.financials['202405'].accounts.reduce((sum, acc) => sum + acc.finalAssets, 0);
        const monthlyProfit = mockData.financials['202405'].accounts.reduce((sum, acc) => {
            const clientPnl = acc.realizedPnl + acc.unrealizedPnl;
            return sum + (clientPnl > 0 ? clientPnl * acc.shareRate : 0);
        }, 0);
        const activeClients = new Set(mockData.financials['202405'].accounts.map(acc => acc.client)).size;
        const winRate = 68.5; // 模拟胜率
        
        document.getElementById('overview-total-aum').textContent = formatMoneyForKpi(totalAum);
        document.getElementById('overview-monthly-profit').textContent = formatMoneyForKpi(monthlyProfit);
        document.getElementById('overview-active-clients').textContent = activeClients;
        document.getElementById('overview-win-rate').textContent = winRate + '%';
        
        // 渲染策略卡片
        const container = document.getElementById('overview-strategies-container');
        container.innerHTML = '';
        
        Object.keys(mockData.strategies).forEach(id => {
            const s = mockData.strategies[id];
            const card = document.createElement('div');
            card.className = 'overview-strategy-card';
            card.innerHTML = `
                <h2 class="text-xl font-semibold text-slate-700 mb-3">${s.name}</h2>
                <div id="overview-chart-${id}" style="width: 100%; height: 200px;" class="mb-4"></div>
                <div class="space-y-2">
                    <p class="text-sm text-gray-600">累计收益率: <span class="font-semibold text-green-600">${formatPercentage(s.kpis.totalReturn)}</span></p>
                    <p class="text-sm text-gray-600">年化收益率: <span class="font-semibold text-blue-600">${formatPercentage(s.kpis.annualReturn)}</span></p>
                    <p class="text-sm text-gray-600">最大回撤: <span class="font-semibold text-red-600">${formatPercentage(s.kpis.maxDrawdown)}</span></p>
                    ${s.kpis.sharpeRatio ? `<p class="text-sm text-gray-600">夏普比率: <span class="font-semibold">${s.kpis.sharpeRatio}</span></p>` : ''}
                    ${s.kpis.alpha ? `<p class="text-sm text-gray-600">Alpha: <span class="font-semibold">${formatPercentage(s.kpis.alpha)}</span></p>` : ''}
                </div>
                <button class="btn-primary w-full mt-4 view-details" data-strategy-id="${id}">
                    查看详情 <i class="fas fa-arrow-right ml-1"></i>
                </button>
            `;
            container.appendChild(card);
            
            // 渲染小图表
            setTimeout(() => {
                const chartDom = document.getElementById(`overview-chart-${id}`);
                if (chartDom) {
                    const myChart = echarts.init(chartDom);
                    myChart.setOption({
                        grid: { top: 10, right: 10, bottom: 10, left: 10 },
                        xAxis: { show: false, type: 'time' },
                        yAxis: { show: false, type: 'value' },
                        series: [{
                            data: s.seriesData,
                            type: 'line',
                            smooth: true,
                            showSymbol: false,
                            lineStyle: { width: 2, color: '#4f46e5' },
                            areaStyle: { color: 'rgba(79, 70, 229, 0.1)' }
                        }]
                    });
                }
            }, 100);
        });
        
        // 渲染最近交易活动
        const recentTrades = document.getElementById('recent-trades');
        recentTrades.innerHTML = '';
        mockData.financials.tradeLog.slice(0, 5).forEach(trade => {
            const tradeElement = document.createElement('div');
            tradeElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-md';
            tradeElement.innerHTML = `
                <div>
                    <p class="text-sm font-medium text-gray-800">${trade.strategy}</p>
                    <p class="text-xs text-gray-500">${trade.datetime}</p>
                </div>
                <div class="text-right">
                    <p class="text-sm font-semibold ${trade.type === '买入' ? 'text-green-600' : 'text-red-600'}">${trade.type}</p>
                    <p class="text-xs text-gray-500">${formatMoneyForKpi(trade.total)}</p>
                </div>
            `;
            recentTrades.appendChild(tradeElement);
        });
        
        // 更新系统状态
        document.getElementById('last-update').textContent = new Date().toLocaleString();
        
        // 绑定查看详情按钮事件
        setTimeout(() => {
            document.querySelectorAll('.view-details').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    navigateTo('strategy-details', e.currentTarget.dataset.strategyId);
                });
            });
        }, 200);
    }
    
    function renderStrategyDetails(strategyId = 'cross-exchange') {
        activeStrategyId = strategyId;
        const s = mockData.strategies[strategyId];
        
        // 填充策略选择器
        const selector = document.getElementById('strategy-selector');
        selector.innerHTML = '';
        Object.keys(mockData.strategies).forEach(id => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = mockData.strategies[id].name;
            if (id === strategyId) option.selected = true;
            selector.appendChild(option);
        });

        document.getElementById('details-strategy-title').textContent = s.name;
        
        // 渲染策略介绍
        const descriptionContainer = document.getElementById('strategy-description');
        descriptionContainer.innerHTML = `
            <p class="text-gray-700 leading-relaxed">${s.description}</p>
            <div class="mt-4">
                <h4 class="font-medium text-gray-700 mb-2">策略特点</h4>
                <div class="flex flex-wrap gap-2">
                    ${s.features.map(feature => `<span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">${feature}</span>`).join('')}
                </div>
            </div>
        `;
        
        // 渲染策略KPI
        const kpisContainer = document.getElementById('strategy-kpis');
        kpisContainer.innerHTML = `
            <div class="text-center">
                <p class="text-xs text-gray-500">累计收益</p>
                <p class="font-semibold text-green-600">${formatPercentage(s.kpis.totalReturn)}</p>
            </div>
            <div class="text-center">
                <p class="text-xs text-gray-500">年化收益</p>
                <p class="font-semibold text-blue-600">${formatPercentage(s.kpis.annualReturn)}</p>
            </div>
            <div class="text-center">
                <p class="text-xs text-gray-500">最大回撤</p>
                <p class="font-semibold text-red-600">${formatPercentage(s.kpis.maxDrawdown)}</p>
            </div>
            <div class="text-center">
                <p class="text-xs text-gray-500">夏普比率</p>
                <p class="font-semibold text-gray-700">${s.kpis.sharpeRatio || 'N/A'}</p>
            </div>
        `;
        
        // 渲染风险提示
        document.getElementById('risk-warning').textContent = s.riskWarning;
        
        // 渲染主图表
        setTimeout(() => {
            const chartDom = document.getElementById('strategy-chart');
            if (chartDom) {
                echarts.dispose(chartDom);
                const myChart = echarts.init(chartDom);
                myChart.setOption({
                    tooltip: { trigger: 'axis' },
                    legend: { data: ['策略净值', 'BTC基准'] },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'time' },
                    yAxis: { type: 'value', scale: true, axisLabel: { formatter: '${value}' } },
                    series: [
                        {
                            name: '策略净值',
                            type: 'line',
                            smooth: true,
                            data: s.seriesData,
                            lineStyle: { color: '#4f46e5' }
                        },
                        {
                            name: 'BTC基准',
                            type: 'line',
                            smooth: true,
                            data: mockData.financials.btcPerformance,
                            lineStyle: { color: '#f97316' }
                        }
                    ]
                });
            }
        }, 100);
        
        renderEarningsCalendar(strategyId, activeCalendarCurrency);
    }

    function renderEarningsCalendar(strategyId, currency) {
        const container = document.getElementById('earnings-calendar');
        const pnlData = mockData.strategies[strategyId]?.dailyPnl || [];
        const pnlMap = new Map(pnlData.map(d => [d.day, d.pnl]));
        
        container.innerHTML = '';
        
        // 添加日历头部
        ['一', '二', '三', '四', '五', '六', '日'].forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.textContent = day;
            container.appendChild(header);
        });
        
        // 添加空白天数（月初偏移）
        const startDayOffset = 6;
        for (let i = 0; i < startDayOffset; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day';
            container.appendChild(emptyDay);
        }

        // 计算统计数据
        let profitDays = 0;
        let lossDays = 0;
        
        // 添加日期和盈亏数据
        for (let day = 1; day <= 31; day++) {
            const pnl = pnlMap.get(day) || 0;
            const dayElement = document.createElement('div');
            let bgClass = 'calendar-day';
            if (pnl > 100) {
                bgClass += ' profit-bg';
                profitDays++;
            }
            if (pnl < -100) {
                bgClass += ' loss-bg';
                lossDays++;
            }
            
            dayElement.className = bgClass;
            dayElement.innerHTML = `
                <div class="text-gray-800 text-sm font-medium">${day}</div>
                <div class="mt-1">${formatMoney(pnl, currency)}</div>
            `;
            container.appendChild(dayElement);
        }

        // 更新统计信息
        const totalDays = profitDays + lossDays;
        const winRate = totalDays > 0 ? ((profitDays / totalDays) * 100).toFixed(1) : 0;
        
        document.getElementById('profit-days').textContent = profitDays;
        document.getElementById('loss-days').textContent = lossDays;
        document.getElementById('win-rate').textContent = winRate + '%';

        // 更新货币切换按钮状态
        document.querySelectorAll('#calendar-currency-switcher button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.currency === currency);
        });
    }

    function renderFinancialsDashboard() {
        const data = mockData.financials['202405'];
        
        // 更新账户选择器
        const accountSelector = document.getElementById('fd-account-selector');
        accountSelector.innerHTML = '<option value="all">所有账户汇总</option>';
        data.accounts.forEach(acc => {
            accountSelector.innerHTML += `<option value="${acc.accountId}">${acc.client} - ${acc.accountId}</option>`;
        });
        
        // 计算汇总数据
        let totalAum = 0, totalGrossProfit = 0;
        data.accounts.forEach(acc => {
            totalAum += acc.finalAssets;
            const clientPnl = acc.realizedPnl + acc.unrealizedPnl;
            totalGrossProfit += clientPnl > 0 ? clientPnl * acc.shareRate : 0;
        });
        const totalCost = data.companyCosts;
        
        document.getElementById('fd-aum').textContent = formatMoneyForKpi(totalAum);
        document.getElementById('fd-gross-profit').textContent = formatMoneyForKpi(totalGrossProfit);
        document.getElementById('fd-cost').textContent = formatMoneyForKpi(totalCost);
        document.getElementById('fd-net-profit').textContent = formatMoneyForKpi(totalGrossProfit - totalCost);
        
        // 渲染详细分解
        const breakdown = data.accounts.reduce((acc, cur) => {
            const clientPnl = cur.realizedPnl + cur.unrealizedPnl;
            acc.initialAssets += cur.initialAssets;
            acc.realizedPnl += cur.realizedPnl;
            acc.unrealizedPnl += cur.unrealizedPnl;
            acc.companyGrossProfit += clientPnl > 0 ? clientPnl * cur.shareRate : 0;
            return acc;
        }, { initialAssets: 0, realizedPnl: 0, unrealizedPnl: 0, companyGrossProfit: 0 });

        document.getElementById('fd-breakdown-content').innerHTML = `
            <div class="kpi-card">
                <p class="text-sm font-medium text-gray-500">期初本金</p>
                <p class="text-2xl font-bold mt-1">${formatMoneyForKpi(breakdown.initialAssets)}</p>
            </div>
            <div class="kpi-card">
                <p class="text-sm font-medium text-gray-500">已实现盈亏</p>
                <p class="text-2xl font-bold mt-1 ${breakdown.realizedPnl >= 0 ? 'text-green-600' : 'text-red-600'}">${formatMoneyForKpi(breakdown.realizedPnl)}</p>
            </div>
            <div class="kpi-card">
                <p class="text-sm font-medium text-gray-500">浮动盈亏</p>
                <p class="text-2xl font-bold mt-1 ${breakdown.unrealizedPnl >= 0 ? 'text-green-600' : 'text-red-600'}">${formatMoneyForKpi(breakdown.unrealizedPnl)}</p>
            </div>
            <div class="kpi-card">
                <p class="text-sm font-medium text-gray-500">公司应占毛利润</p>
                <p class="text-2xl font-bold mt-1 text-indigo-600">${formatMoneyForKpi(breakdown.companyGrossProfit)}</p>
            </div>
        `;
    }

    function renderFinancialsOverview() {
        const { accounts } = mockData.financials['202405'];
        const strategyContribution = {};
        let totalCompanyAr = 0;
        
        accounts.forEach(acc => {
            const clientPnl = acc.realizedPnl + acc.unrealizedPnl;
            const companyAr = clientPnl > 0 ? clientPnl * acc.shareRate : 0;
            strategyContribution[acc.strategy] = (strategyContribution[acc.strategy] || 0) + companyAr;
            totalCompanyAr += companyAr;
        });

        // 策略贡献饼图
        setTimeout(() => {
            const contribChartDom = document.getElementById('strategy-contribution-chart');
            if (contribChartDom) {
                echarts.dispose(contribChartDom);
                echarts.init(contribChartDom).setOption({
                    tooltip: { trigger: 'item', formatter: '{b} : ${c} ({d}%)' },
                    series: [{
                        name: '分润来源',
                        type: 'pie',
                        radius: '70%',
                        data: Object.entries(strategyContribution).map(([name, value]) => ({name, value})),
                        emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0 } }
                    }]
                });
            }
        }, 100);
        
        // 利润趋势图
        setTimeout(() => {
            const profitChartDom = document.getElementById('monthly-profit-chart');
            if (profitChartDom) {
                echarts.dispose(profitChartDom);
                echarts.init(profitChartDom).setOption({
                    tooltip: { trigger: 'axis' },
                    legend: { data: ['应收分润', '运营成本', '净利润'] },
                    xAxis: { type: 'category', data: ['三月', '四月', '五月'] },
                    yAxis: { type: 'value', axisLabel: { formatter: '${value}' } },
                    series: [
                        { name: '应收分润', type: 'bar', data: [55000, 62000, totalCompanyAr] },
                        { name: '运营成本', type: 'bar', data: [14000, 14500, mockData.financials['202405'].companyCosts] },
                        { name: '净利润', type: 'line', data: [41000, 47500, totalCompanyAr - mockData.financials['202405'].companyCosts], smooth: true }
                    ]
                });
            }
        }, 100);
    }

    function renderBilling() {
        const tableBody = document.getElementById('billing-table-body');
        tableBody.innerHTML = '';
        mockData.financials.bills.forEach(bill => {
            const row = document.createElement('tr');
            row.className = 'text-sm';
            row.innerHTML = `
                <td class="px-4 py-3">${bill.date}</td>
                <td class="px-4 py-3">${bill.type}</td>
                <td class="px-4 py-3">${bill.account}</td>
                <td class="px-4 py-3 text-right">${formatMoneyForKpi(bill.amount)}</td>
                <td class="px-4 py-3 text-center">
                    <span class="px-2 py-1 text-xs rounded-full ${bill.status === '已收款' ? 'bg-green-100 text-green-800' : bill.status === '已出账' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">${bill.status}</span>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // 存储原始交易日志数据和当前筛选的数据
    let originalTradingLog = [];
    let filteredTradingLog = [];

    function renderTradingLog() {
        // 初始化原始数据
        if (originalTradingLog.length === 0) {
            originalTradingLog = [...mockData.financials.tradeLog];
            filteredTradingLog = [...originalTradingLog];
        }
        
        const tableBody = document.getElementById('trading-log-table-body');
        tableBody.innerHTML = '';
        
        filteredTradingLog.forEach(trade => {
            const row = document.createElement('tr');
            row.className = 'text-sm';
            row.innerHTML = `
                <td class="px-4 py-3">${trade.datetime}</td>
                <td class="px-4 py-3">${trade.strategy}</td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 text-xs rounded-full ${trade.type === '买入' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${trade.type}</span>
                </td>
                <td class="px-4 py-3 text-right">${formatMoneyForKpi(trade.total)}</td>
            `;
            tableBody.appendChild(row);
        });
        
        // 更新统计信息
        updateTradingLogStats();
    }

    function updateTradingLogStats() {
        const buyCount = filteredTradingLog.filter(t => t.type === '买入').length;
        const sellCount = filteredTradingLog.filter(t => t.type === '卖出').length;
        const totalAmount = filteredTradingLog.reduce((sum, t) => sum + t.total, 0);
        
        document.getElementById('filtered-count').textContent = filteredTradingLog.length;
        document.getElementById('buy-count').textContent = buyCount;
        document.getElementById('sell-count').textContent = sellCount;
        document.getElementById('total-amount').textContent = formatMoneyForKpi(totalAmount);
    }

    function filterTradingLog() {
        const startDate = document.getElementById('log-start-date').value;
        const endDate = document.getElementById('log-end-date').value;
        const strategyFilter = document.getElementById('log-strategy-filter').value;
        const typeFilter = document.getElementById('log-type-filter').value;
        
        filteredTradingLog = originalTradingLog.filter(trade => {
            // 日期筛选
            const tradeDate = trade.datetime.split(' ')[0]; // 提取日期部分
            const tradeDateObj = new Date(tradeDate);
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            
            const dateMatch = (!startDate || tradeDateObj >= startDateObj) && 
                             (!endDate || tradeDateObj <= endDateObj);
            
            // 策略筛选
            const strategyMatch = strategyFilter === 'all' || trade.strategy === strategyFilter;
            
            // 类型筛选
            const typeMatch = typeFilter === 'all' || trade.type === typeFilter;
            
            return dateMatch && strategyMatch && typeMatch;
        });
        
        renderTradingLog();
    }

    function resetTradingLogFilter() {
        // 重置筛选条件
        document.getElementById('log-start-date').value = '2024-05-01';
        document.getElementById('log-end-date').value = '2024-05-31';
        document.getElementById('log-strategy-filter').value = 'all';
        document.getElementById('log-type-filter').value = 'all';
        
        // 重置数据
        filteredTradingLog = [...originalTradingLog];
        renderTradingLog();
    }
    
    // --- 4. 页面渲染器映射 ---
    const pageRenderers = {
        overview: renderOverview,
        'strategy-details': renderStrategyDetails,
        'financials-dashboard': renderFinancialsDashboard,
        'financials-overview': renderFinancialsOverview,
        billing: renderBilling,
        'trading-log': renderTradingLog,
        'client-portal': () => {},
        'api-monitor': renderApiMonitor,
        'position-management': renderPositionManagement,
        'profit-sharing': renderProfitSharing,
        'bill-generator': renderBillGenerator,
        'reporting': () => {},
        settings: () => {}
    };

    // --- 5. 导航控制器 ---
    function navigateTo(pageId, params) {
        // 隐藏所有页面
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        
        // 显示目标页面
        const targetPage = document.getElementById(`page-${pageId}`);
        if (!targetPage) {
            console.error("页面未找到:", pageId);
            return;
        }
        targetPage.classList.remove('hidden');
        
        // 渲染页面内容
        if (pageRenderers[pageId]) {
            try {
                pageRenderers[pageId](params);
            } catch (error) {
                console.error(`渲染页面 ${pageId} 时出错:`, error);
            }
        }
        
        // 更新侧边栏激活状态
        document.querySelectorAll('.sidebar-link, .sidebar-parent').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-page="${pageId}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
            const parentMenu = activeLink.closest('.sidebar-submenu')?.previousElementSibling;
            if (parentMenu) parentMenu.classList.add('active');
        }
        
        // 更新页面标题
        const linkText = activeLink ? activeLink.textContent.trim() : pageId;
        document.getElementById('pageTitle').textContent = linkText;
        
        console.log(`导航到页面: ${pageId}`);
    }
    
    // --- 6. 事件监听器 ---
    // 侧边栏导航
    document.querySelectorAll('.sidebar-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo(e.currentTarget.dataset.page);
        });
    });

    // 财务菜单折叠
    document.getElementById('menu-financials').addEventListener('click', () => {
        document.getElementById('submenu-financials').classList.toggle('open');
    });

    // 策略详情页面事件
    document.addEventListener('change', (e) => {
        if (e.target.id === 'strategy-selector') {
            navigateTo('strategy-details', e.target.value);
        }
    });

    // 货币切换事件
    document.addEventListener('click', (e) => {
        const currencyBtn = e.target.closest('.currency-btn');
        if (currencyBtn) {
            const currency = currencyBtn.dataset.currency;
            if (currency) {
                activeCalendarCurrency = currency;
                renderEarningsCalendar(activeStrategyId, activeCalendarCurrency);
            }
        }
    });

    // --- 7. 初始化 ---
    console.log('融合版本加载完成');
    navigateTo('overview');
    document.getElementById('submenu-financials').classList.add('open');
    
    // 将筛选函数暴露到全局作用域
    window.filterTradingLog = filterTradingLog;
    window.resetTradingLogFilter = resetTradingLogFilter;
});

// 新增渲染函数
function renderApiMonitor() {
    const connections = mockData.apiConnections;
    const totalConnections = connections.length;
    const activeConnections = connections.filter(c => c.status === 'connected').length;
    const failedConnections = totalConnections - activeConnections;
    const todayTrades = connections.reduce((sum, c) => sum + c.todayTrades, 0);

    // 更新KPI
    document.getElementById('total-connections').textContent = totalConnections;
    document.getElementById('active-connections').textContent = activeConnections;
    document.getElementById('failed-connections').textContent = failedConnections;
    document.getElementById('today-trades').textContent = todayTrades;

    // 渲染连接表格
    const tableBody = document.getElementById('api-connections-table');
    tableBody.innerHTML = '';
    connections.forEach(conn => {
        const row = document.createElement('tr');
        row.className = 'text-sm';
        const statusClass = conn.status === 'connected' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        row.innerHTML = `
            <td class="px-4 py-3">${conn.client}</td>
            <td class="px-4 py-3">${conn.accountId}</td>
            <td class="px-4 py-3">${conn.exchange}</td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${conn.status === 'connected' ? '已连接' : '断开连接'}</span>
            </td>
            <td class="px-4 py-3">${conn.lastHeartbeat}</td>
            <td class="px-4 py-3">${conn.todayTrades}</td>
            <td class="px-4 py-3">${conn.permissions}</td>
            <td class="px-4 py-3">
                <button class="text-blue-600 hover:text-blue-800 text-sm">重连</button>
                <button class="text-gray-600 hover:text-gray-800 text-sm ml-2">测试</button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

function renderPositionManagement() {
    const positions = mockData.positions;
    const totalValue = positions.reduce((sum, p) => sum + (p.quantity * p.currentPrice), 0);
    const totalUnrealizedPnl = positions.reduce((sum, p) => sum + p.unrealizedPnl, 0);
    const totalSymbols = new Set(positions.map(p => p.symbol)).size;
    const riskExposure = totalValue * 0.15; // 假设15%的风险敞口

    // 更新KPI
    document.getElementById('total-position-value').textContent = formatMoneyForKpi(totalValue);
    document.getElementById('total-unrealized-pnl').textContent = formatMoneyForKpi(totalUnrealizedPnl);
    document.getElementById('total-unrealized-pnl').className = `text-2xl font-bold mt-1 ${totalUnrealizedPnl >= 0 ? 'text-green-600' : 'text-red-600'}`;
    document.getElementById('total-symbols').textContent = totalSymbols;
    document.getElementById('risk-exposure').textContent = formatMoneyForKpi(riskExposure);

    // 渲染持仓表格
    const tableBody = document.getElementById('positions-table');
    tableBody.innerHTML = '';
    positions.forEach(pos => {
        const row = document.createElement('tr');
        row.className = 'text-sm';
        const pnlClass = pos.unrealizedPnl >= 0 ? 'text-green-600' : 'text-red-600';
        const sideClass = pos.side === 'long' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        row.innerHTML = `
            <td class="px-4 py-3">${pos.client} - ${pos.accountId}</td>
            <td class="px-4 py-3">${pos.strategy}</td>
            <td class="px-4 py-3">${pos.symbol}</td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 text-xs rounded-full ${sideClass}">${pos.side === 'long' ? '做多' : '做空'}</span>
            </td>
            <td class="px-4 py-3">${pos.quantity}</td>
            <td class="px-4 py-3">$${pos.entryPrice.toLocaleString()}</td>
            <td class="px-4 py-3">$${pos.currentPrice.toLocaleString()}</td>
            <td class="px-4 py-3 ${pnlClass}">$${pos.unrealizedPnl.toLocaleString()}</td>
            <td class="px-4 py-3 ${pnlClass}">${pos.pnlPercent > 0 ? '+' : ''}${pos.pnlPercent}%</td>
            <td class="px-4 py-3">${pos.holdTime}</td>
        `;
        tableBody.appendChild(row);
    });
}

function renderProfitSharing() {
    // 填充客户选择器
    const clientSelector = document.getElementById('client-selector');
    const billClientSelector = document.getElementById('bill-client-selector');
    const clients = [...new Set(mockData.financials['202405'].accounts.map(acc => acc.client))];
    
    [clientSelector, billClientSelector].forEach(selector => {
        if (selector) {
            selector.innerHTML = '<option value="">请选择客户</option>';
            clients.forEach(client => {
                selector.innerHTML += `<option value="${client}">${client}</option>`;
            });
        }
    });

    // 渲染分润历史
    const tableBody = document.getElementById('profit-share-history');
    tableBody.innerHTML = '';
    mockData.profitShareHistory.forEach(record => {
        const row = document.createElement('tr');
        row.className = 'text-sm';
        const statusClass = record.status === '已收款' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
        row.innerHTML = `
            <td class="px-4 py-3">${record.date}</td>
            <td class="px-4 py-3">${record.client}</td>
            <td class="px-4 py-3">${record.accountId}</td>
            <td class="px-4 py-3">${formatMoneyForKpi(record.clientProfit)}</td>
            <td class="px-4 py-3">${record.shareRate}%</td>
            <td class="px-4 py-3">${formatMoneyForKpi(record.ourShare)}</td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${record.status}</span>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

function renderBillGenerator() {
    // 填充客户选择器
    const billClientSelector = document.getElementById('bill-client-selector');
    const clients = [...new Set(mockData.financials['202405'].accounts.map(acc => acc.client))];
    billClientSelector.innerHTML = '<option value="">请选择客户</option>';
    clients.forEach(client => {
        billClientSelector.innerHTML += `<option value="${client}">${client}</option>`;
    });

    // 设置默认月份
    const billMonth = document.getElementById('bill-month');
    const currentDate = new Date();
    const lastMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1);
    billMonth.value = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;

    // 渲染账单管理表格
    const tableBody = document.getElementById('bills-management-table');
    tableBody.innerHTML = '';
    mockData.billsManagement.forEach(bill => {
        const row = document.createElement('tr');
        row.className = 'text-sm';
        const sendStatusClass = bill.sendStatus === '已发送' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
        const paymentStatusClass = bill.paymentStatus === '已付款' ? 'bg-green-100 text-green-800' : 
                                 bill.paymentStatus === '待付款' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800';
        row.innerHTML = `
            <td class="px-4 py-3">${bill.billNo}</td>
            <td class="px-4 py-3">${bill.client}</td>
            <td class="px-4 py-3">${bill.month}</td>
            <td class="px-4 py-3">${bill.type}</td>
            <td class="px-4 py-3">${formatMoneyForKpi(bill.amount)}</td>
            <td class="px-4 py-3">${bill.generateDate}</td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 text-xs rounded-full ${sendStatusClass}">${bill.sendStatus}</span>
            </td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 text-xs rounded-full ${paymentStatusClass}">${bill.paymentStatus}</span>
            </td>
            <td class="px-4 py-3">
                <button class="text-blue-600 hover:text-blue-800 text-sm">查看</button>
                <button class="text-green-600 hover:text-green-800 text-sm ml-2">发送</button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// 工具函数
function calculateProfitShare() {
    const clientProfit = parseFloat(document.getElementById('client-profit').value) || 0;
    const shareRate = parseFloat(document.getElementById('calc-share-rate').value) || 0;
    const calculatedAmount = clientProfit * (shareRate / 100);
    const clientNetAmount = clientProfit - calculatedAmount;
    
    document.getElementById('calculated-amount').textContent = formatMoneyForKpi(calculatedAmount);
    document.getElementById('client-net-amount').textContent = formatMoneyForKpi(clientNetAmount);
}

function updateProfitShare() {
    const client = document.getElementById('client-selector').value;
    const shareRate = document.getElementById('profit-share-rate').value;
    const effectiveDate = document.getElementById('effective-date').value;
    
    if (!client || !shareRate || !effectiveDate) {
        alert('请填写完整信息');
        return;
    }
    
    alert(`已更新 ${client} 的分润比例为 ${shareRate}%，生效日期：${effectiveDate}`);
    // 这里可以添加实际的保存逻辑
}

function generateBill() {
    const client = document.getElementById('bill-client-selector').value;
    const month = document.getElementById('bill-month').value;
    const type = document.getElementById('bill-type').value;
    
    if (!client || !month || !type) {
        alert('请填写完整信息');
        return;
    }
    
    // 生成账单预览
    const billPreview = document.getElementById('bill-preview');
    const billContent = document.getElementById('bill-content');
    
    billContent.innerHTML = `
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">量化交易服务账单</h2>
            <p class="text-gray-600">账单月份: ${month}</p>
        </div>
        <div class="grid grid-cols-2 gap-8 mb-6">
            <div>
                <h3 class="font-semibold text-gray-800 mb-2">服务方信息</h3>
                <p>公司名称: 量化交易科技有限公司</p>
                <p>联系电话: +86 138-0000-0000</p>
                <p>邮箱: billing@quant-tech.com</p>
            </div>
            <div>
                <h3 class="font-semibold text-gray-800 mb-2">客户信息</h3>
                <p>客户名称: ${client}</p>
                <p>账单日期: ${new Date().toLocaleDateString()}</p>
                <p>账单编号: BILL-${month.replace('-', '')}-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}</p>
            </div>
        </div>
        <div class="mb-6">
            <h3 class="font-semibold text-gray-800 mb-4">服务明细</h3>
            <table class="w-full border-collapse border border-gray-300">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="border border-gray-300 px-4 py-2 text-left">服务项目</th>
                        <th class="border border-gray-300 px-4 py-2 text-right">金额</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="border border-gray-300 px-4 py-2">${type === 'performance' ? '业绩报酬' : type === 'management' ? '管理费' : '业绩报酬+管理费'}</td>
                        <td class="border border-gray-300 px-4 py-2 text-right">$${(Math.random() * 50000 + 10000).toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="text-right">
            <p class="text-lg font-semibold">总计: $${(Math.random() * 50000 + 10000).toFixed(2)}</p>
        </div>
    `;
    
    billPreview.style.display = 'block';
}

function saveBill() {
    alert('账单已保存到草稿箱');
}

function sendBill() {
    alert('账单已发送给客户');
}

function downloadBill() {
    alert('账单PDF下载功能开发中...');
}

function refreshPositions() {
    alert('持仓数据已刷新');
    // 这里可以添加实际的刷新逻辑
}

function loadClientStrategies() {
    const client = document.getElementById('client-selector').value;
    const container = document.getElementById('strategy-rates-container');
    const listContainer = document.getElementById('strategy-rates-list');
    
    if (!client) {
        container.style.display = 'none';
        return;
    }
    
    // 获取该客户的所有策略
    const clientAccounts = mockData.financials['202405'].accounts.filter(acc => acc.client === client);
    const strategies = [...new Set(clientAccounts.map(acc => acc.strategy))];
    
    listContainer.innerHTML = '';
    strategies.forEach(strategy => {
        const account = clientAccounts.find(acc => acc.strategy === strategy);
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-md';
        div.innerHTML = `
            <span class="text-sm font-medium text-gray-700">${strategy}</span>
            <div class="flex items-center space-x-2">
                <input type="number" value="${(account.shareRate * 100).toFixed(1)}" 
                       class="w-20 px-2 py-1 text-sm border rounded" 
                       min="0" max="100" step="0.1">
                <span class="text-sm text-gray-500">%</span>
            </div>
        `;
        listContainer.appendChild(div);
    });
    
    container.style.display = 'block';
}

function autoCalculateProfit() {
    const month = document.getElementById('profit-month-selector').value;
    const data = mockData.financials[month.replace('-', '')];
    
    if (!data) {
        alert('该月份暂无数据');
        return;
    }
    
    const resultsContainer = document.getElementById('auto-profit-results');
    
    // 按客户分组计算
    const clientGroups = {};
    data.accounts.forEach(acc => {
        if (!clientGroups[acc.client]) {
            clientGroups[acc.client] = [];
        }
        clientGroups[acc.client].push(acc);
    });
    
    let totalOurProfit = 0;
    let resultsHtml = '';
    
    Object.keys(clientGroups).forEach(client => {
        const accounts = clientGroups[client];
        let clientTotalProfit = 0;
        let clientOurShare = 0;
        
        accounts.forEach(acc => {
            const clientPnl = acc.realizedPnl + acc.unrealizedPnl;
            clientTotalProfit += clientPnl;
            if (clientPnl > 0) {
                clientOurShare += clientPnl * acc.shareRate;
            }
        });
        
        totalOurProfit += clientOurShare;
        
        resultsHtml += `
            <div class="bg-gray-50 p-4 rounded-md">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="font-medium text-gray-800">${client}</h4>
                        <p class="text-sm text-gray-600">${accounts.length}个策略账户</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-semibold ${clientTotalProfit >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${formatMoneyForKpi(clientTotalProfit)}
                        </p>
                        <p class="text-sm text-gray-600">应收: ${formatMoneyForKpi(clientOurShare)}</p>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsHtml = `
        <div class="bg-blue-50 p-4 rounded-md mb-4">
            <div class="text-center">
                <p class="text-sm text-blue-600">本月总应收分润</p>
                <p class="text-3xl font-bold text-blue-700">${formatMoneyForKpi(totalOurProfit)}</p>
            </div>
        </div>
        ${resultsHtml}
    `;
    
    resultsContainer.innerHTML = resultsHtml;
}
</script>
</body>
</html> 
